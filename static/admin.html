<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI秘書 - DB管理</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body class="admin-page">
    <div class="container admin-container">
        <header>
            <h1>記憶データベース管理</h1>
            <div class="controls">
                <!-- 
                  no-decoration クラスを使ってCSSで下線を消しています。
                  インラインスタイル (style="...") を避けるのがモダンな書き方です。
                -->
                <a href="/" class="no-decoration">
                    <button class="secondary">チャットに戻る</button>
                </a>
            </div>
        </header>

        <div class="admin-content">
            <!-- フィルタリング用コントロール -->
            <div class="filter-container">
                <!-- 
                   title属性を追加して、このセレクトボックスが何の役割かを示します（アクセシビリティ向上）。
                   CSSクラスを使用してスタイルを適用しています。
                -->
                <select id="category-filter" class="filter-select" title="カテゴリでフィルタリング">
                    <option value="">全てのカテゴリ</option>
                    <option value="attribute">属性 (Attribute)</option>
                    <option value="goal">目標 (Goal)</option>
                    <option value="request">要望 (Request)</option>
                    <option value="memory">記憶 (Memory)</option>
                </select>
                <button onclick="loadMemories()">更新</button>
                <!-- 
                    記憶の圧縮ボタン
                    処理に時間がかかるため、クリック後にローディング表示を行うなどの工夫が必要です。
                -->
                <button id="compress-btn" onclick="compressMemories()"
                    style="background: var(--primary-gradient); color: white; border: none; margin-left: auto;">
                    記憶を圧縮・統合
                </button>
            </div>

            <!-- 
               テーブルラッパー: スマホなどで横幅が収まりきらない場合に
               横スクロールを可能にするためのdivです。
            -->
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <!-- 
                              各列の幅をCSSクラスで指定しています。
                              style="width: ..." と書くよりも、CSSファイルで管理する方が修正が楽です。
                            -->
                            <th class="col-id">ID</th>
                            <th class="col-category">カテゴリ</th>
                            <th>内容</th>
                            <th class="col-date">作成日時</th>
                            <th class="col-action">操作</th>
                        </tr>
                    </thead>
                    <tbody id="memories-body">
                        <!-- ここにJavaScriptで生成した行が挿入されます -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 
      JavaScript: サーバーと通信してデータの取得・更新・削除を行います
    -->
    <script>
        const tbody = document.getElementById('memories-body');
        const filter = document.getElementById('category-filter');

        // サーバーから記憶データを取得して表示する関数
        async function loadMemories() {
            const cat = filter.value;
            // カテゴリが選択されていればクエリパラメータを付与
            const url = cat ? `/api/memories?category=${cat}` : '/api/memories';

            // GETリクエスト送信
            const res = await fetch(url);
            const data = await res.json();

            // テーブルの中身を一度クリア
            tbody.innerHTML = '';

            // データごとの処理
            data.forEach(item => {
                const tr = document.createElement('tr');
                // テンプレートリテラル(``)を使ってHTML文字列を作成
                // エスケープ処理（XSS対策）は本来行うべきですが、今回は簡易実装のため省略しています。
                // テキスト内容にシングルクォートが含まれるとJSエラーになるため、replaceでエスケープしています。
                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td><span class="badge ${item.category}">${item.category}</span></td>
                    <td>${item.content}</td>
                    <td>${new Date(item.created_at).toLocaleString()}</td>
                    <td>
                        <button class="action-btn secondary" onclick="editMemory(${item.id}, '${item.category}', '${item.content.replace(/'/g, "\\'")}')">編集</button>
                        <button class="action-btn delete-btn" onclick="deleteMemory(${item.id})">削除</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 削除機能
        async function deleteMemory(id) {
            if (!confirm('本当に削除しますか？')) return;
            // DELETEメソッドでリクエスト送信
            await fetch(`/api/memories/${id}`, { method: 'DELETE' });
            // 削除後にリストを再読み込みして画面を更新
            loadMemories();
        }

        // 編集機能
        async function editMemory(id, oldCat, oldContent) {
            // ブラウザ標準のpromptダイアログで入力を受け付けます
            const newContent = prompt("内容を編集:", oldContent);
            if (newContent === null) return; // キャンセルされた場合

            const newCat = prompt("カテゴリ (attribute, goal, request, memory):", oldCat);
            if (newCat === null) return;

            // PUTメソッドで更新内容を送信
            await fetch(`/api/memories/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category: newCat, content: newContent })
            });
            loadMemories();
        }

        // フィルタ変更時に自動で再読み込み
        filter.addEventListener('change', loadMemories);

        // 記憶の圧縮処理
        async function compressMemories() {
            if (!confirm('全ての記憶をLLMで整理・圧縮します。時間がかかる場合がありますがよろしいですか？')) return;

            const btn = document.getElementById('compress-btn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = '処理中...';

            try {
                const res = await fetch('/api/memories/compress', {
                    method: 'POST'
                });
                const result = await res.json();

                if (result.status === 'success') {
                    let msg = result.message;
                    if (result.debug_log) {
                        msg += "\n\n--- 圧縮ログ ---\n";
                        msg += "[Prompt]\n" + result.debug_log.prompt + "\n\n";
                        msg += "[LLM Response]\n" + result.debug_log.llm_response;
                        // コンソールにも出力
                        console.log("Compression Log:", result.debug_log);
                    }
                    alert(msg);
                    loadMemories(); // 一覧を更新
                } else {
                    alert(`エラー: ${result.message}`);
                }
            } catch (e) {
                alert('通信エラーが発生しました: ' + e);
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        // 初回読み込み
        loadMemories();
    </script>
</body>

</html>